name: Update Scribe Data and Deploy to Toolforge

on:
  # Trigger on push to main branch.
  push:
    branches: [main, test/toolforge]

  # Trigger: When there is a GitHub Release.
  release:
    types: [published]

  # Manual trigger.
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force data update even if no release'
        required: false
        default: 'false'
        type: boolean

  # Monthly schedule run.
  schedule:
    - cron: '0 0 1 * *' # Run on the 1st of every month at midnight UTC
  
jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hours timeout for large data processing

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y curl git sqlite3 make

    - name: Make script executable
      run: chmod +x ./update_data.sh
    
    - name: Run update script
      run: ./update_data.sh true

    - name: Create deployment package
      run: |
        if [ ! -d "./packs/sqlite" ]; then
          echo "‚ùå SQLite packs directory not found"
          exit 1
        fi

        SQLITE_FILES=$(find ./packs/sqlite -name "*.sqlite" | wc -l)
        if [ "$SQLITE_FILES" -eq 0 ]; then
          echo "‚ùå No SQLite files found"
          exit 1
        fi
        
        echo "‚úÖ Found $SQLITE_FILES SQLite files"
        tar -czf scribe-data-sqlite.tar.gz -C ./packs/sqlite .
        echo "üì¶ Created deployment package"

        # Verify the package was created and show its size
        if [ -f "scribe-data-sqlite.tar.gz" ]; then
          echo "‚úÖ Package created successfully: $(ls -lh scribe-data-sqlite.tar.gz)"
        else
          echo "‚ùå Package creation failed"
          exit 1
        fi

    - name: Upload SQLite files as artifact
      uses: actions/upload-artifact@v4
      with:
        name: scribe-data-sqlite-${{ github.run_number }}
        path: ./scribe-data-sqlite.tar.gz
        retention-days: 30

    - name: Setup SSH for Toolforge deployment
      if: success()
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.TOOLFORGE_SSH_KEY }}

    - name: Deploy to Toolforge
      if: success()
      run: |
        # Add Toolforge to known hosts.
        ssh-keyscan -H login.toolforge.org >> ~/.ssh/known_hosts

        # Verify the package exists before transfer
        if [ ! -f "scribe-data-sqlite.tar.gz" ]; then
          echo "‚ùå Package file not found before transfer"
          exit 1
        fi

        echo "üì§ Transferring package to Toolforge..."
        # Copy the package to Toolforge with verbose output
        scp -v ./scribe-data-sqlite.tar.gz \
          ${{ secrets.TOOLFORGE_USER }}@login.toolforge.org:~/scribe-data-sqlite.tar.gz
        
        if [ $? -ne 0 ]; then
          echo "‚ùå SCP transfer failed"
          exit 1
        fi

        echo "‚úÖ Package transferred successfully"
        
        # Extract and deploy on Toolforge.
        ssh ${{ secrets.TOOLFORGE_USER }}@login.toolforge.org << 'EOF'
          # Verify the file was transferred
          if [ ! -f "~/scribe-data-sqlite.tar.gz" ]; then
              echo "‚ùå Package file not found on Toolforge"
              exit 1
          fi

          echo "üìÅ Package found on Toolforge: $(ls -lh ~/scribe-data-sqlite.tar.gz)"

          # become the tool(our server)
          become scribe-test-server

          cd ~/Scribe-Server || {
            echo "‚ùå Failed to navigate to Scribe-Server directory"
            exit 1
          }

          cp ~/scribe-data-sqlite.tar.gz ./
          
          # Create backup of existing data
          if [ -d "./packs/sqlite" ]; then
            mv ./packs/sqlite ./packs/sqlite.backup.$(date +%Y%m%d_%H%M%S)
          fi
          
          # Create packs directory
          mkdir -p ./packs/sqlite
          
          # Extract new SQLite files
          echo "üì§ Extracting SQLite files..."
          tar -xzf scribe-data-sqlite.tar.gz -C ./packs/sqlite/

          if [ $? -ne 0 ]; then
            echo "‚ùå Failed to extract package"
            exit 1
          fi
          
          # Verify extraction
          echo "Deployed SQLite files:"
          ls -la ./packs/sqlite/

          EXTRACTED_FILES=$(find ./packs/sqlite -name "*.sqlite" | wc -l)
          echo "‚úÖ Extracted $EXTRACTED_FILES SQLite files"
          
          # Run database migration
          make migrate
          
          # Cleanup
          rm ~/scribe-data-sqlite.tar.gz
          rm ./scribe-data-sqlite.tar.gz
          
          echo "‚úÖ Deployment completed successfully"
        EOF

    - name: Notify on success
      if: success()
      run: |
        echo "üéâ Scribe-Data update and deployment completed successfully!"
        echo "üìä SQLite files have been updated on Toolforge"
        echo "üîÑ Database migration completed"
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Deployment failed. Check the logs above for details."
        echo "üîç Common issues:"
        echo "  - SSH key authentication"
        echo "  - Network connectivity to Toolforge"
        echo "  - File transfer permissions"
        echo "  - Package extraction issues"