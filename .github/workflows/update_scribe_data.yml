name: Update Scribe Data and Deploy to Toolforge

on:
  # Dispatch on push to main branch.
  push:
    branches: [main]

  # Will be used when contributor is trying to merge into main.
  # pull_request:
  #   branches: [main, feat/server-matrix-notification]

  # Dispatch when there is a GitHub release.
  release:
    types: [published]

  # Manual dispatch.
  workflow_dispatch:

  # Monthly scheduled dispatch.
  schedule:
    - cron: "0 0 1 * *" # run on the 1st of every month at midnight UTC

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 180 # 3 hours timeout for large data processing

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl git sqlite3 make

      - name: Make script executable
        run: chmod +x ./update_data.sh

      - name: Run update script (skips migration)
        id: run_script
        run: ./update_data.sh true

      - name: Create deployment package
        run: |
          if [ ! -d "./packs/sqlite" ]; then
            echo "‚ùå SQLite packs directory not found"
            exit 1
          fi

          SQLITE_FILES=$(find ./packs/sqlite -name "*.sqlite" | wc -l)
          if [ "$SQLITE_FILES" -eq 0 ]; then
            echo "‚ùå No SQLite files found"
            exit 1
          fi

          echo "‚úÖ Found $SQLITE_FILES SQLite files"
          tar -czf scribe-data-sqlite.tar.gz -C ./packs/sqlite .
          echo "üì¶ Created deployment package"

          # Verify the package was created and show its size.
          if [ -f "scribe-data-sqlite.tar.gz" ]; then
            echo "‚úÖ Package created successfully: $(ls -lh scribe-data-sqlite.tar.gz)"
          else
            echo "‚ùå Package creation failed"
            exit 1
          fi

      - name: Upload SQLite files as artifact
        uses: actions/upload-artifact@v4
        with:
          name: scribe-data-sqlite-${{ github.run_number }}
          path: ./scribe-data-sqlite.tar.gz
          retention-days: 30

      - name: Debug - Check if secret exists
        run: |
          if [ -z "${{ secrets.TOOLFORGE_SSH_KEY }}" ]; then
            echo "SECRET IS EMPTY OR NOT SET"
          else
            echo "Secret exists and has content"
          fi

      - name: Setup SSH for Toolforge deployment
        if: success()
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.TOOLFORGE_SSH_KEY }}

      - name: Deploy to Toolforge
        if: success()
        run: |
          ssh-keyscan -H login.toolforge.org >> ~/.ssh/known_hosts

          echo "üì§ Transferring package to Toolforge..."
          scp -o ConnectTimeout=60 ./scribe-data-sqlite.tar.gz \
            ${{ secrets.TOOLFORGE_USER }}@login.toolforge.org:/data/project/scribe-server/scribe-data-sqlite.tar.gz

          if [ $? -ne 0 ]; then
            echo "‚ùå SCP file transfer failed."
            exit 1
          fi
          echo "‚úÖ Package transferred successfully."

          echo "üöÄ Starting remote deployment process..."
          ssh -o ConnectTimeout=60 \
            ${{ secrets.TOOLFORGE_USER }}@login.toolforge.org << 'DEPLOY_SCRIPT_EOF'

            # Switch to the tool user.
            become scribe-server

            # Running as the tool user (e.g., scribe-server).
            # Current Directory: /data/project/scribe-server

            # Move the package into the Scribe-Server directory.
            if [ ! -f "./scribe-data-sqlite.tar.gz" ]; then
              echo "‚ùå Package not found in project directory."
              exit 1
            fi
            echo "‚úÖ Package verified in project directory."

            mv ./scribe-data-sqlite.tar.gz ./Scribe-Server/
            if [ $? -ne 0 ]; then
              echo "‚ùå Failed to move package into Scribe-Server."
              exit 1
            fi

            # Navigate into the Scribe-Server directory.
            cd ./Scribe-Server || { echo "‚ùå Failed to navigate to Scribe-Server."; exit 1; }

            # Create a backup of existing data.
            if [ -d "./packs/sqlite" ]; then
              BACKUP_NAME="sqlite.backup.$(date +%Y%m%d_%H%M%S)"
              mv ./packs/sqlite ./packs/$BACKUP_NAME
              echo "üì¶ Backed up existing data to $BACKUP_NAME"
            fi

            # Create packs directory and extract the new data.
            mkdir -p ./packs/sqlite
            echo "üì§ Extracting new data..."
            tar -xzf scribe-data-sqlite.tar.gz -C ./packs/sqlite/

            # Run database migration.
            echo "üîÑ Building migration tool..."
            go build -o ./bin/migrate-scribe-data ./cmd/migrate

            echo "üîÑ Running migration tool..."
            ./bin/migrate-scribe-data

            # Clean up the deployment package.
            rm ./scribe-data-sqlite.tar.gz

            echo "üéâ Deployment completed successfully!"

          DEPLOY_SCRIPT_EOF

      - name: Send Matrix Success Notification
        if: success()
        run: |
          echo "üéâ Scribe-Data update completed. Sending report to Matrix..."

          LANG_COUNT="${{ steps.run_script.outputs.LANG_COUNT }}"
          LANG_LIST="${{ steps.run_script.outputs.LANG_LIST }}"
          TYPES_COUNT="${{ steps.run_script.outputs.TYPES_COUNT }}"
          TYPES_LIST="${{ steps.run_script.outputs.TYPES_LIST }}"
          SQLITE_COUNT="${{ steps.run_script.outputs.SQLITE_COUNT }}"

          # Format lists with commas.
          LANG_LIST_FORMATTED=$(echo "$LANG_LIST" | sed 's/ /, /g' | sed 's/"/\\"/g')
          TYPES_LIST_FORMATTED=$(echo "$TYPES_LIST" | sed 's/ /, /g' | sed 's/"/\\"/g')

          TITLE="‚úÖ Toolforge Server Update Successful"
          REPO="${{ github.repository }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          JSON_PAYLOAD=$(cat <<EOF
          {
            "msgtype": "m.text",
            "format": "org.matrix.custom.html",
            "body": "$TITLE - Data updated on Toolforge.",
            "formatted_body": "<h4>$TITLE</h4><ul><li><strong>Languages processed:</strong> $LANG_COUNT ($LANG_LIST_FORMATTED)</li><li><strong>Data types processed:</strong> $TYPES_COUNT ($TYPES_LIST_FORMATTED)</li><li><strong>Data Generation:</strong> Completed</li><li><strong>SQLite Conversion:</strong> Completed</li><li><strong>Files Copied:</strong> $SQLITE_COUNT files to the server</li></ul><p>üéâ Data fetched from Scribe-Data has been updated on Toolforge and migrated to MariaDB!</p><p><a href='$RUN_URL'>View Full Log</a></p>"
          }
          EOF
          )

          curl -v --fail --show-error -X POST "${{ secrets.MATRIX_HOMESERVER }}/_matrix/client/r0/rooms/${{ secrets.MATRIX_DATA_ROOM_ID }}/send/m.room.message?access_token=${{ secrets.MATRIX_SCRIBE_BOT_ACCESS_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed. Check the logs above for details."
          TITLE="‚ùå Toolforge Server Update Failed"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
           curl -X POST "${{ secrets.MATRIX_HOMESERVER }}/_matrix/client/r0/rooms/${{ secrets.MATRIX_DATA_ROOM_ID }}/send/m.room.message?access_token=${{ secrets.MATRIX_SCRIBE_BOT_ACCESS_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"msgtype\": \"m.text\",
              \"format\": \"org.matrix.custom.html\",
              \"body\": \"$TITLE - Automated update process encountered an error.\",
              \"formatted_body\": \"<h4>$TITLE</h4><p>‚ö†Ô∏è The automated update process encountered an error.</p><h5>üîç Details:</h5><ul><li><strong>Workflow:</strong> ${{ github.workflow }}</li><li><strong>Job:</strong> ${{ github.job }}</li><li><strong>Branch:</strong> ${{ github.ref_name }}</li></ul><p><a href='$RUN_URL'>View Full Log</a></p><h5>‚ö†Ô∏è Common Issues:</h5><ul><li>SSH authentication to Toolforge</li><li>Wikidata dump download timeout</li><li>Corrupted/Bad Wikidata dump downloaded</li><li>SQLite generation errors</li><li>Network connectivity issues</li></ul><p>Please check the logs for more details.</p>\"
            }" || echo "‚ö†Ô∏è Failed to send Matrix notification (non-fatal)"
